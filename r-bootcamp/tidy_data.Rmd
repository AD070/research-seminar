---
title: "Реструктуризация данных в R с помощью tidyr"
date: '9 октября 2017 г '
output: 
  html_document: 
    toc: true
    toc_float: true
---


```{r Загрузка библиотек, warning=FALSE, message=FALSE}
library(tidyverse)

# Раскомментируйте и запустите следующие команды, 
# если у вас не ставится tidyverse

#library(tidyr)

```

#"Чистые" данные

Данные могут быть представлены в различной форме. Например, следующие примеры наборов данных содержат одни и те же переменные `country`, `year`, `population`, `cases`, но хранятся они по-разному:

```{r Примеры наборов данных}

table1
table2
table3
table4a
table4b
table5

```

Однако только табличное представление `table1` наиболее удобно для обработки и анализа данных. В данном представлении все переменные расположены по столбцам, все наблюдения - по строкам, и в каждой ячейке таблицы хранится одно значение. Данные в такой форме будем называть **чистыми** (tidy). 

!["Чистые" данные](pics/tidydata.png)

Преимуществами такой формы представления данных является, во-первых, единообразие, которое позволяет применять единый подход к обработке данных и облегчает изучение инструментов, позволяющих эту обработку производить; во-вторых, такая форма позволяет применять векторную обработку значений, на которую ориентировано большинство функций в R.

Рассмотрим функции пакета `tidyr`, позволяющие привести данные к "чистому" формату:

 - `gather()` - свертка столбцов в строки;    
 - `spread()` - развертка строк в столбцы;  
 - `separate()` - разделение значений одного столбца на несколько;  
 - `unite()` - объединение значений нескольких столбцов в один.  
 

#Свертка столбцов в строки с помощью функции `gather()`

Одной из проблем набора данных может быть то, что в названиях столбцов содержатся не названия переменных, а **значения** переменных. Чтобы привести данные к удобному формату, нужно **собрать** (gather) данные столбцов в две новые переменные. 

![Работа функции gather()](pics/gather.png)

Функция `gather()` имеет следующие параметры:

- `data` - набор данных;  
- перечень столбцов, которые представляют собой значения переменных, а не их названия;
- `key` - название новой переменной, в которой будут храниться названия старых столбцов;  
- `value` - название новой переменной, в которой будут храниться значения ячеек старых столбцов.  

##Пример `gather()`

В наборе данных `table4a` названия столбцов `1999` и `2000` являются значениями переменной `year`. С помощью функции `gather()` данные столбцов будут свернуты в две переменные: `year` с названиями столбцов `1999` и `2000` и `cases` с значениями ячеек столбцов `1999` и `2000`.

```{r Пример gather()}

table4a
gather(table4a, `1999`,`2000`, key = "year", value = "cases")

```

##Упражнения `gather()`

Произведите свертку столбцов следующего набора данных:

```{r gather, упражнение 1}
sales <- tibble(
  goods = c("Milk", "Cheese", "Butter", "Sour cream"),
  moscow = c(350,430,360,570),
  `st-petersburg` = c(210,270,150,250),
  novosibirsk = c(120,150,210,140),
  total = c(680,850,720,960)
)

# Напишите свой код здесь
```

#Развертка строк в столбцы с помощью функции `spread()`

Иногда наблюдения "разбросаны" по нескольким строкам. В этом случае функция `spread()` позволяет собрать данные, относящиеся к одному наблюдению в одну строку.

![Работа функции spread()](pics/spread.png)

Функция `spread()` имеет следующие параметры:

- `data` - набор данных;  
- `key` - название столбца, в котором содержатся названия переменных, для которых будут созданы столбцы;  
- `value` - название столбца, в котором содержатся значения переменных.  

##Пример `spread()`

В наборе данных `table2` столбце `type` содержатся названия переменных `cases` и `population`, а в столбце `count` - значения переменных. С помощью функции `spread()` создадим переменные `cases` и `population` и перенесем в них значения из столбца `count`:

```{r Пример spread()}

table2
spread(table2, key = type, value = count)

```

##Упражнения `spread()`

Произведите развертку строк следующего набора данных:

```{r spread, упражнение 1}

grades <- tribble(
~name, ~subject, ~grade,
#-----------------|--------|------
"Ivan Ivanov", "Logistics", 4,
"Ivan Ivanov", "Research seminar", 5,
"Ivan Ivanov", "Logistics", 10,
"Peter Petrov", "Logistics", 8,
"Peter Petrov", "Research seminar", 8
)

# Напишите свой код здесь
```

#Разделение значений столбца с помощью функции `separate()`

Иногда значения нескольких переменных могут быть записаны в одном столбце через разделитель. В этом случае для обработки значений этих переменных необходимо разнести их по столбцам. Справиться с этой проблемой позволяет функция `separate()`.

![Работа функции separate()](pics/separate.png)

Функция `separate()` имеет следующие параметры:

- `data` - набор данных;  
- `col` - название столбца, содержащего значения, которые нужно разделить;  
- `into` - вектор названий столбцов, в которые будут помещены разделенные значения;  
- `sep` - разделитель значений, по умолчанию - любой встречающийся символ, не являющийся буквой или цифрой;  
- `convert` - если параметр равен `TRUE`, то разделенные значения будут конвертированы в наиболее подходящие типы. Параметр особенно полезен, когда разделяемые значения - числовые.

##Пример `separate()`

В наборе данных `table3` в столбце `rate` записаны через разделитель "/" значения переменных `cases` и `population`. Разнесем их в соответствующие столбцы.

```{r Пример separate()}

table3
separate(table3, rate, into = c("cases", "population"))
separate(table3, rate, into = c("cases", "population"), convert = TRUE)

```

##Упражнения `separate()`

Разделите значения в следующего набора данных:

```{r separate, упражнение 1}
addresses <- tibble(address = c(
  "123022, г. Москва, Б. Трехсвятительский пер., д.3",
  "105187, г. Москва, ул. Кирпичная, д.33",
  "100100, г. Москва, ул. Мясницкая, д.13, стр. 4"
)
)

# Напишите свой код здесь
```

#Объединение значений столбцов с помощью функции `unite()`

Функция `unite()` позволяет соединить значения нескольких столбцов в один.

![Работа функции unite()](pics/unite.png)

Функция имеет следующие параметры:

- `data` - набор данных;  
- `col` - название нового столбца, в котором будут соединенные значения;  
- перечень столбцов, из которых будут соединяться значения;  
- `sep` - разделитель значений в новом столбце, по умолчанию "_".  


##Пример `unite()`

В наборе данных `table5` первые и последние две цифры года разнесены по столбцам `century` и `year`. Соединим их в столбце `new`.

```{r Пример unite()}

table5
unite(table5, new, century, year, sep = "")

```

##Упражнения `unite()`

Используя функцию unite(), создайте столбец, в котором для каждой даты проставлено соответствие времени года и год. Например, для даты "01-01-2017" - "зима 2017".

```{r unite, упражнение 1}
dates <- tibble(date = c("02-01-2015", "05-04-2015", "27-09-2017", "18-07-2016","09-12-2014"))

# Напишите свой код здесь
```

