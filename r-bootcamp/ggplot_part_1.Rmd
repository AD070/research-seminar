---
title: "Визуализация данных с помощью ggplot2, часть 1"
date: 2017-09-05
output: 
  html_document: 
    toc: true
    toc_float: true
---

# Введение

В рамках курса вы познакомитесь с принципами визуализации данных при помощи пакета ggplot2. Этот пакет реализует концепцию **"грамматики графики"** (**grammar of graphics**) - специального языка, позволяющего описать любую визуализацию данных. В этом блокноте мы покажем базовые элементы грамматики - геометрические объекты и эстетики, статистические преобразования, шкалы и координатные системы. Во второй части будут рассмотрены слои, а также вопросы визуализации категориальных данных и оформления графиков.

```{r Подключение пакетов, warning=FALSE, message=FALSE}
library(tidyverse)
library(nycflights13)
```



#1
ggplot1 грамматика графики, gglpot - геомы и эстетики, слои, оси, шкалы. Статистики и вычисленные переменные. count/ncount/density… Гистограммы и столбики. Боксплоты. метки осей. панели, ? Отличия coord_trans() и x/ylim(). Примеры анализа распределений.

#2
Разбор дз. ggplot2. stat_summary(). все про столбики. факторы. координатные системы, настройка шкал. hline/vline. слои.


# Связывание (mapping) и определение (setting)

Познакомимся с набором данных о топливной эффективности автомобилей.

```{r Загрузка данных о топливной эффективности}
data(mpg)
head(mpg)
```

Этот набор данных содержит сведения о топливной эффективности различных моделей автомобилей, собранных агентством EPA. Посмотреть описание столбцов набора данных можно выполнив команду: `?mpg`. В этом блоконоте мы будем использовать некоторые из переменных данного набора - пробег на 1 галлоне топлива по трассе (`hwy`), объем двигателя в литрах (`displ`), тип привода (`drv`), число цилиндров двигателя (`cyl`).


## Минимальный шаблон графика. Связывание (mapping) эстетик

Грамматика графики, реализованная в ggplot2, позволяет **связать** (**map**) столбцы набора данных с характеристиками геометрических объектов, которые используются для визуализации данных. 

Геометрические объекты (**geom**) - это точки, столбцы, линии, полигоны и др. Характеристиками этих объектов являются положение (`x` и `y`), цвет, размер, заливка, символ, прозрачность и т.п. В ggplot2 визуальные характеристики называются **эстетиками** (**aesthetics**).

Таким образом, чтобы построить график, необходимо как минимум:

 - указать, с каким набором данных мы хотим работать,  
 - выбрать тип визуализации (геом),  
 - связать эстетики выбранного геома и столбцы в таблице данных.
 
 
[Картинка - связывание столбцов]

Вот минимальный шаблон графика:

```
ggplot(data = <DATA>) +
  <GEOM_FUNCTION>(mapping = aes(<MAPPINGS>))
  
```

Применим этот шаблон, чтобы изучить зависимость пробега по шоссе на одном галлоне (`hwy`) от объема двигателя (`displ`). Мы построим диаграмму рассеяния, элементами которой являются точки (`geom_point`):

```{r Минимальный график в ggplot2}

ggplot(data = mpg) +
  geom_point(mapping = aes(x = displ, y = hwy))

```


**Замечания:**

 1. Набор данных для графика можно указать в аргументах функции `ggplot()`.
 
 2. Геометрические объекты добавляются на график как отдельные слои, с помощью оператора `+`. Здесь мы добавили только один слой. Обратите внимание, что при добавлении слоя знак `+` должен быть в конце первой строки, а не в начале второй.
 
 3. Для слоя необходимо связать эстетики и столбцы таблицы данных, задав соответствие при помощи аргумента `mapping=` и функции `aes()`. Здесь мы связали положение точки - `x` и `y` со столбцами `displ` и `hwy`.
 
 4. Внутри функции `aes()` вы можете использовать имена столбцов набора данных напрямую, без префикса и `$`. 
 
 5. Всегда используйте для связывания только столбцы из таблицы, которая указана как источник данных для графика. Не стоит использовать не включенные в эту таблицу данные (отдельные векторы или столбцы других таблиц).

## Другие эстетики

У каждого геометрического объекта есть свой набор эстетик, которые можно использовать для визуализации данных. Доступные варианты можно посмотреть в справке - `?geom_point`.

Например, для точек можно использовать следующие эстетики: 

 - положение (`x`, `y`),  
 - прозрачность (`alpha`),  
 - цвет (`colour`),
 - фигура (`shape`),
 - размер (`size`),
 и [др.](http://ggplot2.tidyverse.org/reference/#section-aesthetics)

Используем дополнительные эстетики, чтобы отобразить более сложную зависимость между переменными в наборе данных:

```{r Дополнительные эстетики}
ggplot(data = mpg) +
  geom_point(mapping = aes(x = displ, y = hwy,
                           colour = drv))
```

Связав тип привода `drv` с цветом, мы можем видеть более сложные зависимости. Например, что среди машин с объемом двигателя до 4 литров почти нет заднеприводных (`drv = 'r'`), или что при равном объеме двигателя полноприводные автомобили (`drv = '4'`) имеют меньший пробег на 1 галлоне топлива.

Вы можете подобрать любые сочетания эстетик для визуализации своих данных, однако стоит помнить о том, что сложность этих эстетик для восприятия разная. Человеку легче всего сравнивать расположение и линейные размеры объектов. А оттенки цвета люди различают плохо. Поэтому стоит помнить правило:

> Самые важные переменные следует связывать с эстетиками положения.

Эстетики можно условно разделить на два вида: **количественные**, пригодные для отображения количественных данных и **качественные**, пригодные для отображения категорий.

![Количественные и качественные эстетики](pics/aesthetics.png)

В `gglot2` вы можете связывать данные с какими угодно эстетиками, однако если, например связать категориальную переменную (фактор) с количественной эстетикой (размер), то вы получите предупреждение. Цвет можно связывать как с количественными, так и с категориальными переменными, при этом будет выбрана подходящая цветовая шкала.


### Упражнение: связывание данных

В этом упражнении вы будете работать с набором данных о характеристиках и стоимости бриллиантов.

```{r Загрузка и просмотр набора diamonds}
head(diamonds)
```

С описанием набора можно познакомиться в справке: `?diamonds`.

Ваша задача - повторить визуализацию, показанную на рисунке.

![Визуализация зависимости цены бриллианта от его характеристик](pics/diamonds_mapping.png)

**Совет:** вы можете открыть график в новом окне, кликнув по ссылке на него с нажатой клавшией `Shift`. Если RStudio жалуется на отсутствующий файл, - выполните команду меню: `Session/Set Working Directory/To Source File Location`, чтобы установить в качестве рабочей директории папку, в которой находится данный блокнот.

```{r Упражнение на связывание данных по бриллиантам}
# Раскомментируйте и допишите этот код:

#ggplot(data = ___) +
#  geom_point(mapping = aes(x = ____,
#                           y = ____,
#                           ______))

```


## Определение (setting) эстетик

Когда эстетика связывается со столбцом данных, значение в этом столбце определяет значение эстетики (level). Однако иногда необходимо вместо **связывания** (**mapping**) использовать явное **определение** (**setting**) значений эстетики. В этом случае у всех графических элементов значение эстетики будет одинаковым, - таким как вы зададите.

Чтобы явно определить значение эстетики, необходимо задать это значение вне функции `aes()`. Как правило, при определении эстетик используются константы.

```{r Связывание и определение эстетики}

# Связывание цвета с переменной
ggplot(data = mpg) +
  geom_point(mapping = 
               aes(x = displ,y = hwy,
                   color = drv)) # внутри aes()!

# Определение цвета
ggplot(data = mpg) +
  geom_point(mapping = 
               aes(x = displ, y = hwy),
             color = 'blue') # вне aes()!

```


Если случайно попытаться определить значение эстетики внутри функции `aes()`, то можно получить неожиданный результат:

```{r Связывание по ошибке}

ggplot(data = mpg) +
  geom_point(mapping = 
               aes(x = displ, y = hwy,
                   color = 'blue')) # ошибка: внутри aes()! 

```

Здесь вместо определения цвета точек произошло по ошибке связывание цвета с константой `'blue'`. Однако при связывании `ggplot2` самостоятельно определяет, какие цвета будут соответствовать каким значениям, поэтому мы и получили такой результат.

### Упражнение: определение эстетики

В этом упражнении продолжите работу с набором данных `diamonds`.

Постройте визуализацию зависимости цены бриллианта от его веса и класса огранки (`cut`), запустив следующий блок кода.

```{r Упражнение на определение эстетики}
# Измените код, чтобы задать прозрачность всех точек 5%
ggplot(data = diamonds) +
  geom_point(mapping = 
               aes(x = carat, y = price, 
                   colour = cut))
```

Точки на графике плохо различимы из-за наложения. Ваша задача - сделать точки полупрозрачными (прозрачность - 5%, или 0.05).


# Геомы и статистики

**Геомы** (**geom**) - это геометрические объекты, которые используются для визуализации данных на графике. Можно рассматривать их как разные способы визуализации данных. Например, на диаграмме рассеяния для визуализации используются точки (`geom_point()`), на ящичной диаграмме - ящики (`geom_boxplot()`), на гистограмме или столбиковой диаграмме - столбики (`geom_bar()`).

В `ggplot2` поддерживается большое количество типов визуализации, реализованных в виде функций `geom_...()`. Вы можете добавлять геомы к своей визуализации как отдельные слои.

Со списком доступных геомов можно познакомиться:

  - в [документации ggplot2](http://ggplot2.tidyverse.org/reference/#section-layer-geoms)
  
  - или в [шпаргалке по ggplot2](https://www.rstudio.com/wp-content/uploads/2016/11/ggplot2-cheatsheet-2.1.pdf). 
  
  Шпаргалка всегда доступна в меню RStudio: `Help>Cheatsheets>Data visualization with ggplot2`.

В этом блокноте мы рассмотрим несколько геомов, которые можно использовать для визуализации распределений количественных переменных.

## Гистограммы

Гистограммы применяются для визуализации распределений количественных переменных. В `ggplot2` для построения гистограмм используется функция `geom_histogram()`. Гистограмма - одномерный способ визуализации данных, поэтому при связывании эстетик с данными требуется указать только одну эстетику положения - `x`.


```{r Гистограмма топливной эффективности}
ggplot(data = mpg) +
  geom_histogram(mapping = aes(x = hwy))
```

Для построения гистограммы используется группировка данных в интервалы. По умолчанию количество интервалов выбирается равным 30, однако часто требуется скорректировать количество интервалов, чтобы сделать визуализацию распределения более наглядной. При уменьшении количества интервалов, что эквивалентно увеличению их ширины, степень сглаживания данных возрастает. 

Для настройки интервалов используются два аргумента функции `geom_histogram()`: 

  - `bins` (количество интервалов, ширина определяется автоматически) и  
  - `binwidth` (ширина интервала, количество определяется автоматически).
  
  Кроме того, можно передать вектор с явно заданными границами интервалов через аргумент `breaks`.
  
  
```{r Настройка ширины интервала гистограммы}
ggplot(data = mpg) +
  geom_histogram(mapping = aes(x = hwy),
                 binwidth = 2)
```


## Статистические преобразования (stat)

Рассмотрим предыдущий график подробнее. На горизонтальной оси отображены значения переменной `hwy`, которую мы связали с эстетикой положения `x`. Однако на вертикальной оси мы видим переменную `count` (число наблюдений на интервале), которой не было в исходном наборе данных:

```{r Столбцы исходного набора данных mpg}
names(mpg)
```

Причина в том, что часто для визуализации исходные данные подвергаются преобразованиям. В нашем примере потребовалось разбить диапазон значений переменной `hwy` на интервалы заданной ширины и подсчитать количество наблюдений на каждом интервале. 

В `ggplot2` любой геом связан с некоторым **статистическим преобразованием** (**stat**), которое применяется к данным. Например, в справке по `?geom_histogram` можно убедиться, что по умолчанию для этого геома используется статистическое преобразование - группировка в интервалы (**binning**): `stat = 'bin'`.

Статистические преобразования доступны в виде отдельных функций. 

Имена статистических функций полезно знать, чтобы смотреть по ним справку. Также их можно добавлять как слои на визуализацию, т.к. каждая статистика связана по умолчанию с определенным геомом.

Имена этих функций формируются по шаблону: `stat_...()`. Например, функция для группировки в интервалы назыавется: `stat_bin()`.

В справке `?stat_bin` можно посмотреть, какие показатели (**Computed variables**) вычисляет эта функция:

  - `count` - количество наблюдений на интервале (частота),  
  - `density` - плотность вероятности (площадь под кривой плотности = 1),  
  - `ncount` - нормированная частота, такая что максимальное значение частоты = 1 (удобно для сравнения распределений),  
  - `ndensity` - нормированная плотность.


[схема данные -> статистика -> производные показатели]


Вычисленные показатели можно связывать с эстетиками. При этом, чтобы отличать их от переменных в исходном наборе данных, необходимо в начале и в конце имени вычисленного показателя добавлять `..`:


```{r Гистограмма с плотностью вероятности}
ggplot(data = mpg) +
  geom_histogram(mapping = 
                   aes(x = hwy, y = ..density..),
                 binwidth = 2)
```

**Замечание:** плотность вероятности выгодно отличается от частоты тем, что значения на оси `y` не зависят от заданной ширины интервалов:

$$ d_i = \frac{n_i}{N \cdot \Delta_i} $$

В то время как при использовании частот, чем шире интервалы - тем выше частота. 

Плотность распределения вычисленную эмпирически на основе данных, можно сравнивать с плотностью какого-либо предполагаемого распределения, например нормального. Как это сделать - можно посмотреть в блокноте `plotting_functions.Rmd`.


## Упражнение: гистограмма

Используя набор данных `diamonds`, постройте гистограмму веса бриллиантов (`carat`). На гистограмме должна отражаться нормированная частота. Подберите ширину интервала, которая, на ваш взгляд, хорошо подходит к этим данным (достаточное сглаживание, нет пустых интервалов).

```{r Гистограмма веса бриллиантов}
# Раскомментируйте и дополните код:
#ggplot(data = diamonds) +
#  geom_histogram(aes(x = ___, y = ___),
#                 binwidth = ___)
```



# Шкалы

# Системы координат

